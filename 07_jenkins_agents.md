# Агенты Jenkins

- [Агенты Jenkins](#агенты-jenkins)
  - [Виды агентов Jenkins](#виды-агентов-jenkins)
    - [Постоянные агенты](#постоянные-агенты)
    - [Динамические агенты](#динамические-агенты)
  - [Настройка постоянного агента через SSH](#настройка-постоянного-агента-через-ssh)
    - [Шаг 1: Подготовка агента](#шаг-1-подготовка-агента)
    - [Шаг 2: Создание пользователя Jenkins](#шаг-2-создание-пользователя-jenkins)
    - [Шаг 3: Настройка в Jenkins Web UI](#шаг-3-настройка-в-jenkins-web-ui)
    - [Шаг 4: Добавление SSH credentials](#шаг-4-добавление-ssh-credentials)
    - [Рекомендации по управлению рабочим пространством](#рекомендации-по-управлению-рабочим-пространством)
  - [Настройка Docker агентов](#настройка-docker-агентов)
    - [Предварительная настройка Docker хоста](#предварительная-настройка-docker-хоста)
    - [Шаг 1: Установка Docker Plugin](#шаг-1-установка-docker-plugin)
    - [Шаг 2: Настройка Docker Cloud](#шаг-2-настройка-docker-cloud)
    - [Шаг 3: Создание Docker Template](#шаг-3-создание-docker-template)
    - [Шаг 4: Пример использования динамических Docker агентов](#шаг-4-пример-использования-динамических-docker-агентов)
  - [Хорошие практики для масштабирования](#хорошие-практики-для-масштабирования)
  - [Библиография](#библиография)

## Виды агентов Jenkins

Агенты Jenkins — это отдельные машины или контейнеры, которые выполняют задачи сборки, параллельно с узлом-контроллером или вместо него. Не рекомендуется запускать сборки непосредственно на узле-контроллере из соображений безопасности и производительности.

При установке Jenkins по умолчанию создается один встроенный агент, который работает на том же сервере, что и контроллер Jenkins. Однако, в целях безопасности и повышения надежности, рекомендуется отключить встроенный агент и использовать отдельные агенты для выполнения задач сборки.

Jenkins предлагает следующие типы агентов:

- Постоянные агенты (Permanent Agents)
- Динамические агенты (Dynamic Agents, On-Demand Agents)

### Постоянные агенты

**Постоянные агенты** это сервера, которые всегда работают и подключены к контроллеру Jenkins. Они могут быть физическими серверами, виртуальными машинами или контейнерами, которые настроены для выполнения задач сборки.

**Преимущества:**

- Предсказуемая производительность
- Кастомизированная конфигурация
- Быстрый старт сборок (нет времени на поднятие и настройку агента)

**Недостатки:**

- Требуют постоянных ресурсов для работы
- Ручное управление и обслуживание
- Ограниченная масштабируемость

### Динамические агенты

**Динамические агенты** это агенты, создаваемые по требованию. Они могут быть реализованы с помощью облачных провайдеров, контейнеров или оркестраторов, таких как Kubernetes.

**Преимущества:**

- Эффективное использование ресурсов
- Легко масштабируются
- Автоматическое управление жизненным циклом

**Недостатки:**

- Более сложная настройка
- Потенциальные задержки при создании агентов  

## Настройка постоянного агента через SSH

Взаимодействие между контроллером Jenkins и постоянным агентом может осуществляться через протокол JNLP или SSH. Для Unix-подобных систем обычно используется SSH.

Для настройки постоянного агента через SSH необходимо, чтобы на целевой машине был установлен SSH сервер и Java Development Kit (JDK).

### Шаг 1: Подготовка агента

На целевой машине убедитесь, что установлены Java и SSH сервер. Например, для Ubuntu/Debian:

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install openjdk-17-jdk-headless openssh-server
```

Для CentOS/RHEL:

```bash
# CentOS/RHEL
sudo yum install java-17-openjdk-headless openssh-server
sudo systemctl enable sshd
sudo systemctl start sshd
```

### Шаг 2: Создание пользователя Jenkins

В целях безопасности рекомендуется создать отдельного пользователя для Jenkins агента и настроить SSH ключи для аутентификации без пароля.

```bash
# Создание пользователя
sudo useradd -m -s /bin/bash jenkins

# Создание SSH ключа для подключения
sudo -u jenkins ssh-keygen -t rsa -b 4096 -f /home/jenkins/.ssh/jenkins_key

# Настройка авторизованных ключей
sudo -u jenkins cp /home/jenkins/.ssh/jenkins_key.pub /home/jenkins/.ssh/authorized_keys
sudo -u jenkins chmod 600 /home/jenkins/.ssh/authorized_keys
```

### Шаг 3: Настройка в Jenkins Web UI

1. Перейдите в `Manage Jenkins > Manage Nodes and Clouds`
2. Нажмите `New Node`
3. Заполните параметры:
   - **Name**: `static-agent-01`
   - **Type**: `Permanent Agent`
   - **Number of executors**: `2` (количество параллельных задач)
   - **Remote root directory**: `/home/jenkins/workspace`
   - **Labels**: `static-agent`
   - **Usage**: `Use this node as much as possible`
   - **Launch method**: `Launch agents via SSH`
   - **Host**: IP адрес или hostname агента
   - **Credentials**: добавьте SSH ключ из шага 2

### Шаг 4: Добавление SSH credentials

1. В разделе Credentials нажмите `Add`
2. Выберите `SSH Username with private key`
3. Заполните:
   - **Username**: `jenkins`
   - **Private Key**: скопируйте содержимое `/home/jenkins/.ssh/jenkins_key`
   - **ID**: `jenkins-ssh-key`
   - **Description**: `Jenkins SSH Key for Static Agents`

Пример использования постоянного агента в Jenkinsfile:

```groovy
// Использование постоянного агента
pipeline {
    agent {
        label 'static-agent'
    }
    stages {
        stage('Build') {
            steps {
                sh 'echo "Building on static agent: ${NODE_NAME}"'
                sh 'make build'
            }
        }
    }
}
```

### Рекомендации по управлению рабочим пространством

Постоянные агенты накапливают файлы сборок в рабочих директориях, что может привести к проблемам с дисковым пространством и конфликтам между сборками. Поэтому рекомендуется регулярно очищать рабочее пространство.

**Очистка workspace после сборки:**

```groovy
pipeline {
    agent { label 'static-agent' }
    stages {
        stage('Build') {
            steps {
                sh 'make build'
            }
        }
    }
    post {
        always {
            cleanWs()  // Очистка после завершения (успех или ошибка)
        }
    }
}
```

## Настройка Docker агентов

Агенты на базе Docker позволяют Jenkins динамически создавать контейнеры для выполнения задач сборки и сразу же удалять их после завершения.

Существуют три различных способа интеграции Docker с Jenkins:

- Использование Docker in Docker (DinD);
- Подключение к удаленному Docker хосту посредством TCP;
- Использование Docker сокета хоста (`unix:///var/run/docker.sock`) в случае, если Jenkins работает в контейнере.

Подключение к удаленному Docker хосту посредством TCP является наиболее универсальным способом, так как позволяет изолировать Jenkins от Docker хоста (Jenkins и Docker могут работать на разных машинах).

### Предварительная настройка Docker хоста

Для подключения Jenkins к Docker хосту по TCP необходимо настроить Docker демона на прослушивание TCP соединений.

> [!WARNING]
> Использование Docker API через TCP без TLS (порт 2375) открывает полный доступ к Docker для любого, кто имеет доступ к сети. Это критическая уязвимость безопасности! Для производственных окружений обязательно используйте TLS (порт 2376) или ограничьте доступ через firewall только для доверенных IP-адресов.

Для тестовых окружений на компьютере с ОС Windows необходимо перейти в настройки Docker Desktop и включить опцию "`Expose daemon on tcp://localhost:2375 without TLS`". В данном случае на хосте можно будет управлять Docker по адресу `tcp://localhost:2375` без использования TLS.

Пользователи Linux могут изменить конфигурацию Docker демона. Для systemd-based систем создайте или отредактируйте файл `/etc/systemd/system/docker.service.d/override.conf`:

```ini
[Service]
ExecStart=
ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375
```

Или используйте файл `/etc/docker/daemon.json` (требует модификации systemd unit):

```json
{
  "hosts": ["tcp://0.0.0.0:2375"]
}
```

После внесения изменений необходимо перезапустить Docker сервис:

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### Шаг 1: Установка Docker Plugin

1. Перейдите в `Manage Jenkins > Manage Plugins`
2. Найдите и установите `Docker Plugin`
3. Перезапустите Jenkins

### Шаг 2: Настройка Docker Cloud

1. Перейдите в `Manage Jenkins > Manage Nodes and Clouds > Configure Clouds`
2. Нажмите `Add a new cloud` и выберите `Docker`
3. Заполните настройки:
   - **Name**: `docker-cloud`
   - **Docker Host URI**: `tcp://host.docker.internal:2375`
   - **Enabled**: установите флажок

Адрес `host.docker.internal` используется для доступа к Docker хосту из контейнеров. Однако, также можно использовать реальный IP адрес или hostname Docker хоста.

### Шаг 3: Создание Docker Template

В разделе Docker Agent templates добавьте новый template:

- **Labels**: `docker-agent`
- **Name**: `docker-agent-{0}`
- **Docker Image**: `jenkins/agent:latest`
- **Instance Capacity**: `10`
- **Remote File System Root**: `/home/jenkins/agent`
- **Connect Method**: `Attach Docker container` (или `Connect with SSH` в зависимости от образа)

Любой образ, на базе которого настроен Jenkins агент, должен иметь установленный JRE и необходимые инструменты для сборки. Однако, выбор метода подключения к агенту также определяет необходимость установки дополнительных зависимостей. Например, если используется подключение через JNLP, то в образе должен быть установлен JNLP агент. Для базового образа можно использовать официальные образы Jenkins:

- `jenkins/ssh-agent` — для подключения по SSH;
- `jenkins/inbound-agent` — для подключения через JNLP;
- `jenkins/agent` — базовый образ, обычно используется при прямом подключении через Docker API.

Данные образы, однако, не содержат инструментов сборки (Maven, Node.js, Docker CLI и т.д.), поэтому для реальных задач рекомендуется использовать собственные образы, основанные на этих базовых образах, с предустановленными необходимыми инструментами или использовать образы из Docker Hub, которые уже содержат нужные инструменты.

### Шаг 4: Пример использования динамических Docker агентов

```groovy
// Использование конкретного Docker агента
pipeline {
    agent {
        label 'docker-agent'
    }
    stages {
        stage('Hello World') {
            steps {
                sh 'echo "Hello from Docker Agent: ${NODE_NAME}"'
            }
        }
    }
}
```

## Хорошие практики для масштабирования

- **Используйте динамические агенты** для большинства сборок. Динамические агенты позволяют эффективно использовать ресурсы.
- **Резервируйте постоянные агенты** для критически важных или длительных задач: например, для интеграционных тестов.
- **Настройте политики автоматического масштабирования (auto-scaling)** на основе длины очереди. Это поможет автоматически масштабировать количество агентов в зависимости от нагрузки.
- **Отслеживайте использование агентов** и оптимизируйте их количество.
- **Используйте метки (labels)** для разных типов сборок (Maven, Node.js, Docker).
- **Настройте лимиты ресурсов** для предотвращения перегрузки агентов.

## Библиография

1. Humble, Jez; Farley, David. **Continuous Delivery: Reliable Software Releases through Build, Test, and Deployment Automation** - Addison-Wesley Professional, 2010.
   - Фундаментальная работа о непрерывной доставке и оптимизации pipeline
2. [Jenkins Documentation - Distributed Builds](https://www.jenkins.io/doc/book/scaling/)
   - Официальная документация по масштабированию Jenkins
3. [Jenkins Docker Plugin](https://plugins.jenkins.io/docker-plugin/)
   - Документация по Docker плагину для Jenkins
