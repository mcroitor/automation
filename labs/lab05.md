# IW05: Ansible playbook для конфигурации сервера

## Цель

Научиться создавать Ansible playbook для автоматизации конфигурации серверов.

## Подготовка

Задание выполняется на базе лабораторной работы IW04.

Создайте папку `lab05` в вашем репозитории GitHub для хранения всех файлов, связанных с этой лабораторной работой. У вас должен быть установлен Docker и Docker Compose для выполнения задания. У вас также должен быть репозиторий с проектом PHP, содержащим модульные тесты, как в лабораторной работе IW04.

Скопируйте из предыдущей лабораторной работы `lab04` файлы в папку `lab05`.

Задание включает в себя также описание шагов из предыдущих лабораторных работ с пометкой "Повторение".

## Задание

Создайте файл `compose.yaml`.

### 1. Установка и настройка Jenkins

[!INFO] Повторение

Jenkins будет использоваться для управления всеми этапами автоматизации.

Создайте в файле `compose.yaml` сервис "jenkins-controller". Запустите контейнер Jenkins Controller с помощью Docker Compose и настройте его, следуя инструкциям на экране. Установите необходимые плагины: Docker, Docker Pipeline, GitHub Integration, SSH Agent.

### 2. Подготовка SSH агента

[!INFO] Повторение

Агент SSH будет использоваться Jenkins для сборки PHP проекта и выполнения модульных тестов.

Создайте файл `Dockerfile.ssh_agent` для SSH агента. Установите необходимые пакеты (PHP-CLI и, возможно, другие зависимости). Создайте ключи SSH для интеграции Jenkins с SSH агентом и настройте Jenkins для использования этих ключей.

Добавьте в `compose.yaml` сервис "ssh-agent", используя созданный Dockerfile.

### 3. Создание агента Ansible

Агент Ansible будет использоваться Jenkins для выполнения Ansible playbook, который будет настраивать тестовый сервер.

Создайте файл `Dockerfile.ansible_agent` для агента Ansible на базе Ubuntu. В этом файле установите Ansible и необходимые зависимости.

Создайте ключи SSH для интеграции Jenkins с Ansible агентом и настройте Jenkins для использования этих ключей.

Создайте ключи SSH для подключения Ansible агента к тестовому серверу и настройте Ansible для использования этих ключей. Подключение к тестовому серверу должно выполняться от имени пользователя `ansible`.

Добавьте в `compose.yaml` сервис "ansible-agent", используя созданный Dockerfile.

### 4. Создание тестового сервера

Тестовый сервер будет представлять собой тестовое окружение, которое будет настраиваться с помощью Ansible playbook и в рамках которого будет тестироваться работоспособность PHP приложения.

Создайте файл `Dockerfile.test_server` с конфигурацией тестового сервера на базе Ubuntu. В этом файле установите openssh-server и настройте его для работы с SSH ключами.

Создайте пользователя `ansible` на тестовом сервере и настройте SSH для подключения к серверу от имени этого пользователя с использованием созданных ранее SSH ключей.

### 5. Создание Ansible playbook для настройки тестового сервера

Создайте папку `ansible`. В этой папке определите инвентарный файл `hosts.ini`, в котором укажите параметры подключения к тестовому серверу.

Создайте Ansible playbook `setup_test_server.yml`, который будет выполнять следующие задачи на тестовом сервере:

1. Установка и настройка Apache2.
2. Установка и настройка PHP и необходимых расширений.
3. Настройка виртуального хоста Apache для PHP проекта.

### 6. Конвейер для сборки и тестирования PHP проекта

[!INFO] Повторение

Создайте папку `pipelines` в папке `lab05`.

Создайте в Jenkins конвейер (pipeline) для сборки и тестирования PHP проекта, используя SSH агент. Для этого создайте файл `php_build_and_test_pipeline.groovy` в папке `pipelines`.

Конвейер должен включать следующие этапы:

1. Клонирование репозитория с PHP проектом.
2. Установка зависимостей проекта с помощью Composer.
3. Запуск модульных тестов с помощью PHPUnit.
4. Отчет о результатах тестирования.

### 7. Конвейер для настройки тестового сервера с помощью Ansible

Создайте в Jenkins конвейер (pipeline) для настройки тестового сервера с помощью Ansible агента. Для этого создайте файл `ansible_setup_pipeline.groovy` в папке `pipelines`.

Конвейер должен включать следующие этапы:

1. Клонирование репозитория с Ansible playbook.
2. Выполнение Ansible playbook для настройки тестового сервера.

### 8. Конвейер для размещения PHP проекта на тестовом сервере

Создайте в Jenkins конвейер (pipeline) для размещения PHP проекта на тестовом сервере. Для этого создайте файл `php_deploy_pipeline.groovy` в папке `pipelines`.

Конвейер должен включать следующие этапы:

1. Клонирование репозитория с PHP проектом.
2. Копирование файлов проекта на тестовый сервер.
3. Конфигурация проекта на тестовом сервере (если необходимо).

Размещение кода проекта на тестовом сервере может выполняться при помощи Ansible.

### 9. Тестирование размещенного PHP проекта

Откройте веб-браузер и перейдите по адресу тестового сервера, чтобы убедиться, что PHP проект успешно размещен и работает корректно.

### Подготовка отчета

Создайте файл `readme.md` в папке `lab05` вашего репозитория GitHub. В отчете опишите следующие моменты:

1. Описание проекта.
2. Шаги по настройке Jenkins Controller.
3. Шаги по настройке SSH агента.
4. Шаги по созданию и настройке агента Ansible.
5. Шаги по созданию тестового сервера.
6. Описание Ansible playbook и его задач.
7. Шаги по созданию конвейеров Jenkins для сборки и тестирования PHP проекта, настройки тестового сервера и размещения PHP проекта.
8. Ответьте на вопросы:
    - Какие преимущества использования Ansible для настройки серверов?
    - Какие еще бывают модули Ansible для управления конфигурацией?
    - Какие проблемы вы столкнулись при создании Ansible playbook и как вы их решили?

## Представление

Загрузите проект в репозиторий GitHub и предоставьте ссылку на него.

## Оценивание

| Критерий                                                   | Нет | Частично | Да   |
| ---------------------------------------------------------- | --- | -------- | ---- |
| Создан файл `compose.yaml` с необходимыми сервисами        | 0   | 5        | 10   |
| Создан Ansible playbook для настройки тестового сервера    | 0   | 10       | 20   |
| Созданы конвейер Jenkins для сборки и тестирования проекта | 0   | 5        | 10   |
| Созданы конвейер Jenkins для настройки тестового сервера   | 0   | 10       | 20   |
| Созданы конвейер Jenkins для размещения PHP проекта        | 0   | 10       | 20   |
| Описание выполнения работы в отчете                        | 0   | 5        | 10   |
| Ответы на вопросы в отчете                                 | 0   | 5        | 10   |
| Каждый день опоздания                                      | 0   | 0        | -20  |
| Плагиат                                                    | 0   | -50      | -100 |
| **Итого**                                                  |     |          | 100  |
