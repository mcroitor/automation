# Jenkins

- [Jenkins](#jenkins)
  - [Установка Jenkins](#установка-jenkins)
  - [Настройка Jenkins](#настройка-jenkins)
  - [Управление дополнениями](#управление-дополнениями)
  - [Jenkinsfile](#jenkinsfile)
    - [Декларативный синтаксис](#декларативный-синтаксис)
    - [Скриптовый синтаксис](#скриптовый-синтаксис)
  - [Основы программирования Jenkinsfile](#основы-программирования-jenkinsfile)
    - [Переменные и типы данных](#переменные-и-типы-данных)
    - [Базовые конструкции](#базовые-конструкции)
      - [Условные конструкции](#условные-конструкции)
      - [Циклы](#циклы)
    - [Объявление функций](#объявление-функций)
    - [Встроенные команды и функции](#встроенные-команды-и-функции)
  - [Основы создания конвейеров в Jenkins](#основы-создания-конвейеров-в-jenkins)
    - [Работа с переменными окружения](#работа-с-переменными-окружения)
    - [Параметризация сборки](#параметризация-сборки)
    - [Обработка ошибок и отказоустойчивость](#обработка-ошибок-и-отказоустойчивость)
  - [Простой пример Jenkinsfile](#простой-пример-jenkinsfile)
  - [Заключение](#заключение)
  - [Библиография](#библиография)

Система автоматизации Jenkins широко используется для реализации процессов непрерывной интеграции и доставки (CI/CD). Она позволяет автоматизировать сборку, тестирование и развертывание приложений, обеспечивая быструю и надежную доставку программного обеспечения.

Работа с Jenkins организуется в виде распределённой системы, состоящей из **контроллера** (главного сервера) и **агентов** (исполняющих узлов). Контроллер управляет задачами, распределяет их между агентами и собирает результаты. Агенты выполняют задачи, такие как сборка кода, запуск тестов и развертывание приложений. Агенты могут быть как динамическими (создаются по требованию), так и статическими (постоянно доступными). К динамическим агентам относятся, например, контейнеры Docker, которые запускаются и уничтожаются по мере необходимости.

## Установка Jenkins

Jenkins можно установить на различные операционные системы, включая Windows, macOS и Linux. Минимальные требования к железу для установки Jenkins:

- Процессор: 2 CPU (4+ CPU ядер рекомендуется)
- Оперативная память: 256 МБ (4+ ГБ рекомендуется)
- Место на диске: 1 ГБ (50+ ГБ рекомендуется)

Установка в Linux (на примере Ubuntu):

```bash
sudo apt update
sudo apt install fontconfig openjdk-21-jre
sudo wget -O /etc/apt/keyrings/jenkins-keyring.asc \
  https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
echo "deb [signed-by=/etc/apt/keyrings/jenkins-keyring.asc]" \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null
sudo apt update
sudo apt install jenkins
```

Также существует возможность запуска Jenkins в контейнере Docker, что упрощает процесс установки и настройки. В случае запуска Jenkins в Docker, рекомендуется дополнительно 10 ГБ.

Пример запуска Jenkins через Docker:

```bash
docker run -p 8080:8080 -p 50000:50000 --restart=on-failure -v jenkins_home:/var/jenkins_home jenkins/jenkins:lts
```

Следует отметить, что порт 50000 используется для связи между Jenkins контроллером и агентами. Для сохранения данных Jenkins необходимо использовать том, монтируемый в `/var/jenkins_home`.

> [!NOTE]
> Не рекомендуется монтировать локальную директорию в `/var/jenkins_home`, так как это может привести к проблемам с правами доступа и совместимостью файловой системы.

Для простоты работы с Jenkins в Docker можно использовать `docker-compose`. Пример файла `docker-compose.yml` для запуска Jenkins:

```yaml
services:
  jenkins:
    image: jenkins/jenkins:lts
    restart: on-failure
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins_home:/var/jenkins_home
  ssh-agent:
    image: jenkins/ssh-agent

volumes:
  jenkins_home:
```

В данном случае создается дополнительный сервис `ssh-agent`, в котором поднимается SSH сервер. Он позволяет подключаться к другим серверам по SSH, что полезно для выполнения задач, требующих удаленного доступа.

## Настройка Jenkins

После установки Jenkins необходимо выполнить первоначальную настройку. Для этого откройте веб-браузер и перейдите по адресу `http://localhost:8080`. Вам будет предложено ввести пароль установки, который можно найти в файле `/var/jenkins_home/secrets/initialAdminPassword` внутри контейнера Jenkins. При запуске Jenkins в Docker, этот пароль будет доступен в логах контейнера.

После ввода пароля вам будет предложено установить рекомендуемые плагины и создать первого администратора. По умолчанию Jenkins включает базовые возможности для работы с Git и Java, остальные интеграции можно добавить по необходимости.

Начальная установка Jenkins в Docker будет включать в себя работу с Java и Node.js, для остальных языков программирования надо добавлять средства сборки и тестирования. Для этого необходимо определить собственный Dockerfile с нужными инструментами и использовать его в качестве образа для Jenkins.

Пример Dockerfile для Jenkins с поддержкой Python:

```Dockerfile
FROM jenkins/jenkins:lts
USER root

RUN apt-get update && apt-get install -y python3 python3-pip

USER jenkins
```

Однако, проще и эффективнее собирать приложения в отдельных контейнерах, а Jenkins использовать только для оркестрации процессов CI/CD.

## Управление дополнениями

Дополнения (плагины) расширяют возможности Jenkins и позволяют интегрироваться с различными инструментами и сервисами. Управление дополнениями осуществляется через веб-интерфейс в разделе "Управление Jenkins" → "Управление дополнениями".

Jenkins имеет множество дополнений, но для базового CI/CD процесса рекомендуется установить следующие:

- **Git** — работа с репозиториями Git
- **Pipeline** — поддержка конвейеров как кода
- **Docker Pipeline** — интеграция с Docker
- **NodeJS** — поддержка Node.js проектов
- **JUnit** — публикация результатов тестов

Для интеграции с внешними системами рекомендуется установить:

- **GitHub** — интеграция с GitHub (веб-перехватчики, статусы)
- **GitLab** — интеграция с GitLab
- **Slack Notification** — уведомления в Slack
- **Email Extension** — расширенные возможности электронной почты

Наконец, для анализа качества кода полезно установить:

- **SonarQube Scanner** — анализ качества кода
- **HTML Publisher** — публикация отчетов в формате HTML
- **Cobertura** — отчеты о покрытии кода

Дополнительно можно установить расширение **Blue Ocean**, которое предоставляет современный интерфейс для визуализации конвейеров и упрощает их создание и управление.

> [!NOTE]
> Расширение Blue Ocean было признано Jenkins устаревшим в 2023 году и больше не поддерживается.

## Jenkinsfile

`Jenkinsfile` — это текстовый файл, который содержит все этапы и шаги вашего конвейера. Он может быть создан в корне вашего проекта и должен быть добавлен в систему контроля версий. `Jenkinsfile` пишется на языке Groovy и поддерживает два типа синтаксиса: декларативный и скриптовый.

### Декларативный синтаксис

При декларативном синтаксисе `Jenkinsfile` имеет следующую структуру:

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                // Шаги для сборки
            }
        }
        stage('Test') {
            steps {
                // Шаги для тестирования
            }
        }
        stage('Deploy') {
            steps {
                // Шаги для развертывания
            }
        }
    }
    post {
        always {
            // Действия, которые выполняются всегда после завершения конвейера
        }
        success {
            // Действия при успешном завершении
        }
        failure {
            // Действия при неудаче
        }
    }
}
```

В этом примере:

- `pipeline` — корневой блок, определяющий конвейер;
- `agent any` — указывает, что конвейер может выполняться на любом доступном агенте Jenkins;
- `stages` — блок, содержащий все этапы конвейера;
- `stage('Stage Name')` — определяет отдельный этап с именем;
- `steps` — блок, содержащий конкретные шаги, которые должны быть выполнены на данном этапе;
- `post` — блок, определяющий действия, которые должны быть выполнены после завершения конвейера, в зависимости от его результата.

### Скриптовый синтаксис

Скриптовый синтаксис обеспечивает большую гибкость программирования, но требует глубокого знания языка Groovy.

```groovy
node {
    stage('Build') {
        // Шаги для сборки
    }
    stage('Test') {
        // Шаги для тестирования
    }
    stage('Deploy') {
        // Шаги для развертывания
    }
}
```

Декларативный синтаксис проще и более структурирован, что облегчает чтение и поддержку.

## Основы программирования Jenkinsfile

В языке Groovy можно определять переменные, использовать условные конструкции, циклы, собственные функции и многое другое, что позволяет создавать сложные и гибкие конвейеры.

### Переменные и типы данных

Для определения переменных используется ключевое слово `def`:

```groovy
def myVariable = "Hello, Jenkins!"
```

Типы данных в Groovy включают:

- Числа (целые и с плавающей точкой);
- Строки;
- Булевы значения (true/false);
- Списки (аналог массивов);
- Карты (аналог словарей или объектов);
- Классы.

### Базовые конструкции

#### Условные конструкции

Как и во многих языках программирования, в Groovy используются условные конструкции для выполнения различных действий в зависимости от условий.

```groovy
if (env.BRANCH_NAME == 'main') {
    sh 'echo "Deploying to production"'
} else {
    sh 'echo "Deploying to staging"'
}
```

Также можно использовать конструкции `switch` для множественного выбора:

```groovy
switch (env.BRANCH_NAME) {
    case 'main':
        sh 'echo "Deploying to production"'
        break
    case 'develop':
        sh 'echo "Deploying to staging"'
        break
    default:
        sh 'echo "Deploying to test environment"'
}
```

#### Циклы

В Groovy доступны различные типы циклов, такие как `for`, `while` и `each`.

Пример использования цикла `for`:

```groovy
def environments = ['dev', 'staging', 'prod']
for (env in environments) {
    sh "echo Deploying to ${env}"
}
```

Тот же пример с использованием метода `each`:

```groovy
def environments = ['dev', 'staging', 'prod']
environments.each { env ->
    sh "echo Deploying to ${env}"
}
```

И, соответственно, цикл `while`:

```groovy
def environments = ['dev', 'staging', 'prod']
def index = 0
while (index < environments.size()) {
    def env = environments[index]
    sh "echo Deploying to ${env}"
    index++
}
```

### Объявление функций

Функции в Groovy объявляются с помощью ключевого слова `def`:

```groovy
def logString(logType, message) {
    return "[${logType}] ${message}"
}
echo logString('INFO', 'Pipeline started')
echo logString 'ERROR', 'Pipeline failed'
```

### Встроенные команды и функции

Jenkins предоставляет множество встроенных команд и функций для выполнения различных задач в конвейерах:

- `sh 'command'` — выполнение shell-команды на агенте (для Linux);
- `bat 'command'` — выполнение командной строки на агенте (для Windows);
- `checkout scm` — проверка исходного кода из системы контроля версий;
- `archiveArtifacts 'path'` — архивирование артефактов для последующего использования;
- `junit 'path'` — публикация результатов тестов в формате JUnit;
- `mail to: 'email', subject: 'subject', body: 'body'` — отправка email-уведомления.
- `docker.build('image-name')` — сборка Docker-образа;
- `docker.image('image-name').run()` — запуск контейнера из Docker-образа;

## Основы создания конвейеров в Jenkins

После изучения синтаксиса Groovy и основных конструкций языка, рассмотрим ключевые аспекты создания практических конвейеров в Jenkins. Эти знания помогут создавать гибкие и надежные CI/CD процессы для реальных проектов.

### Работа с переменными окружения

Jenkins предоставляет множество встроенных переменных окружения, которые содержат полезную информацию о текущей сборке. Дополнительно можно определять собственные переменные через блок `environment`.

```groovy
pipeline {
    agent any
    environment {
        MY_VAR = 'custom_value'
        NODE_VERSION = '21'
    }
}
```

Переменные окружения доступны через объект `env`.

**Основные встроенные переменные:**

- `env.BRANCH_NAME` — имя текущей ветки
- `env.BUILD_NUMBER` — номер текущей сборки  
- `env.WORKSPACE` — путь к рабочей директории
- `env.JOB_NAME` — имя задачи Jenkins

Пример использования переменных окружения:

```groovy
pipeline {
    agent any
    environment {
        // Пользовательские переменные окружения
        MY_VAR = 'custom_value'
        NODE_VERSION = '21'
    }
    stages {
        stage('Environment Info') {
            steps {
                sh 'echo "Branch: ${env.BRANCH_NAME}"'
                sh 'echo "Build number: ${env.BUILD_NUMBER}"'
                sh 'echo "Workspace: ${env.WORKSPACE}"'
                sh 'echo "Node version: ${env.NODE_VERSION}"'
            }
        }
    }
}
```

### Параметризация сборки

Параметры позволяют создавать интерактивные сборки, где пользователь может задать значения во время запуска. Это особенно полезно для развертывания в разные окружения или управления поведением конвейера.

**Типы параметров:**

- `choice` — выбор из предопределенного списка
- `booleanParam` — флаг true/false  
- `string` — текстовое поле
- `password` — скрытое текстовое поле

```groovy
pipeline {
    agent any
    parameters {
        choice(
            name: 'ENVIRONMENT', 
            choices: ['dev', 'staging', 'prod'], 
            description: 'Целевое окружение для развертывания'
        )
        booleanParam(
            name: 'SKIP_TESTS', 
            defaultValue: false, 
            description: 'Пропустить выполнение тестов'
        )
        string(
            name: 'VERSION', 
            defaultValue: '1.0.0', 
            description: 'Версия для развертывания'
        )
    }
    stages {
        stage('Deploy') {
            steps {
                script {
                    // Использование параметров в логике конвейера
                    if (!params.SKIP_TESTS) {
                        sh 'npm test'
                    }
                    sh "echo Deploying version ${params.VERSION} to ${params.ENVIRONMENT}"
                }
            }
        }
    }
}
```

### Обработка ошибок и отказоустойчивость

Правильная обработка ошибок критически важна для стабильной работы CI/CD конвейеров. Jenkins предоставляет несколько механизмов для контроля выполнения и реакции на сбои.

**Основные подходы:**

- Блоки `try-catch` для локальной обработки ошибок
- Секция `post` для действий после завершения стадий
- Управление статусом сборки через `currentBuild.result`

```groovy
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                script {
                    try {
                        sh 'npm run build'
                        echo "Build completed successfully"
                    } catch (Exception e) {
                        echo "Build failed: ${e.getMessage()}"
                        // Установка статуса сборки
                        currentBuild.result = 'FAILURE'
                        // Повторное выбрасывание исключения для остановки конвейера
                        throw e
                    }
                }
            }
        }
    }
    post {
        failure {
            echo "Pipeline failed - sending notifications"
            // Здесь можно добавить уведомления о сбое
        }
        always {
            echo "Cleaning up workspace"
            cleanWs() // Очистка рабочей области
        }
    }
}
```

## Простой пример Jenkinsfile

Пример базового `Jenkinsfile` для Node.js проекта:

```groovy
pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh '''
                    node --version
                    npm --version
                    npm ci
                '''
            }
        }
        
        stage('Lint') {
            steps {
                sh 'npm run lint'
            }
        }
        
        stage('Test') {
            steps {
                sh 'npm test'
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm run build'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        failure {
            echo "Build failed!"
        }
        success {
            echo "Build successful!"
        }
    }
}
```

Доступ к переменным окружения, параметрам сборки и другим данным Jenkins также возможен через встроенные функции и методы Groovy.

## Заключение

Jenkins является мощным инструментом для автоматизации процессов CI/CD. Основные преимущества:

- **Гибкость**: Поддержка различных языков программирования и технологий
- **Расширяемость**: Большое количество плагинов
- **Интеграция**: Работа с популярными системами контроля версий
- **Масштабируемость**: Поддержка распределенных сборок

Для эффективного использования Jenkins важно:

- Писать понятные и поддерживаемые Jenkinsfile
- Следовать принципам DevOps
- Регулярно обновлять систему и плагины
- Мониторить производительность сборок

## Библиография

1. [Pipeline as Code, Jenkins](https://www.jenkins.io/doc/book/pipeline/pipeline-as-code)
2. [edeshina, Jenkins Scripted Pipeline: как использовать, Habr, 2023-01-10](https://habr.com/ru/companies/slurm/articles/709804)
3. [Pipeline as Code with Jenkins, Jenkins](https://www.jenkins.io/solutions/pipeline)
